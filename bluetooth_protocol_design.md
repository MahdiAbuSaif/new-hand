# تصميم بروتوكول الاتصال عبر البلوتوث للعب الجماعي

يحدد هذا المستند بنية وتدفق الرسائل لتمكين اللعب الجماعي عبر اتصال بلوتوث بين أجهزة أندرويد التي تشغل تطبيق لعبة الورق.

## 1. اكتشاف الأقران والاتصال (Peer Discovery & Connection)

*   **الاستخدام:** واجهة برمجة تطبيقات بلوتوث أندرويد (Bluetooth APIs).
*   **الخطوات:**
    1.  **جعل الجهاز قابلاً للاكتشاف:** يجب أن يتمكن الجهاز المضيف (الذي يبدأ اللعبة الجماعية) من جعل نفسه قابلاً للاكتشاف لأجهزة أخرى لفترة محدودة.
    2.  **اكتشاف الأجهزة:** يمكن للأجهزة العميلة البحث عن الأجهزة القابلة للاكتشاف التي تشغل نفس التطبيق (يمكن استخدام UUID مخصص للتطبيق للتعرف عليه).
    3.  **الاقتران والاتصال:** يبدأ العميل طلب اتصال بالجهاز المضيف. قد يتطلب الأمر اقتران بلوتوث قياسي إذا لم تكن الأجهزة مقترنة مسبقًا.
    4.  **إنشاء مآخذ توصيل آمنة (Secure Sockets):** بمجرد الاتصال، يتم إنشاء مآخذ توصيل RFCOMM آمنة بين المضيف وكل عميل لتبادل بيانات اللعبة.

## 2. بنية رسائل بيانات اللعبة

*   **التنسيق:** سيتم استخدام تنسيق JSON لتبادل الرسائل لسهولة التحليل والتوسيع.
*   **أنواع الرسائل الأساسية:**
    *   `GAME_SETUP`: يرسلها المضيف لبدء اللعبة، تحتوي على نوع اللعبة المختارة، أسماء اللاعبين، ترتيب الأدوار.
    *   `DEAL_CARDS`: يرسلها المضيف لتوزيع الأوراق الأولية لكل لاعب.
    *   `PLAYER_ACTION`: يرسلها اللاعب الذي عليه الدور إلى المضيف (والمضيف يعيد توجيهها للآخرين إذا لزم الأمر)، تحتوي على نوع الإجراء (سحب، رمي، إنزال، مزايدة، اختيار مملكة) والبيانات المرتبطة به (مثل الورقة المسحوبة/المرمية).
    *   `GAME_STATE_UPDATE`: يرسلها المضيف لجميع اللاعبين لتحديث حالة اللعبة (مثل الأوراق المرمية، النقاط، اللاعب الحالي).
    *   `ROUND_END`: يرسلها المضيف للإشارة إلى نهاية الجولة وتضمين النتائج.
    *   `GAME_END`: يرسلها المضيف للإشارة إلى نهاية اللعبة وتضمين النتيجة النهائية.
    *   `CHAT_MESSAGE`: رسالة دردشة اختيارية بين اللاعبين.
    *   `ERROR / DISCONNECT`: للإبلاغ عن أخطاء أو انقطاع الاتصال.
*   **مثال لرسالة `PLAYER_ACTION` (رمي ورقة):**
    ```json
    {
      "type": "PLAYER_ACTION",
      "action": "DISCARD",
      "player_id": "player_2",
      "card": { "suit": "HEARTS", "rank": "KING" }
    }
    ```

## 3. تدفق الاتصال أثناء اللعب

1.  **المضيف المركزي:** يعمل جهاز المضيف كنقطة مركزية لإدارة حالة اللعبة وتدفق الرسائل. يتلقى الإجراءات من اللاعبين ويقوم بتحديث حالة اللعبة وإعادة بثها إلى جميع العملاء.
2.  **مزامنة الحالة:** يجب أن يضمن المضيف أن جميع اللاعبين لديهم نفس رؤية حالة اللعبة. يتم إرسال تحديثات الحالة (`GAME_STATE_UPDATE`) بعد كل إجراء لاعب أو تغيير مهم في اللعبة.
3.  **معالجة الأخطاء وانقطاع الاتصال:**
    *   يجب أن يكون لدى التطبيق آلية لاكتشاف انقطاع اتصال أحد اللاعبين.
    *   يمكن للمضيف إيقاف اللعبة مؤقتًا والسماح بإعادة الاتصال، أو إنهاء اللعبة، أو استبدال اللاعب المنقطع بلاعب ذكاء اصطناعي (حسب تصميم اللعبة).

## 4. اعتبارات إضافية

*   **الأمان:** استخدام اتصالات بلوتوث آمنة (secure RFCOMM) لمنع التنصت أو التلاعب.
*   **الكفاءة:** ضغط البيانات إذا لزم الأمر لتقليل التأخير، خاصة مع زيادة عدد اللاعبين.
*   **واجهة المستخدم:** توفير ملاحظات واضحة للمستخدم حول حالة الاتصال (متصل، جارٍ البحث، انقطع الاتصال).
